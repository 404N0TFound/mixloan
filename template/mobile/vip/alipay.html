<!DOCTYPE html> 
<html> 
    <head> 
        <meta charset="UTF-8"> 
        <title>支付</title> 
        <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" /> 
        <link rel="stylesheet" href="../addons/xuan_mixloan/template/style/mui/css/mui.min.css" /> 
        <script type="text/javascript" src="../addons/xuan_mixloan/template/style/mui/js/mui.min.js"></script> 
        <style type="text/css"> 
            .top {  
                margin-top: 40%;  
            }  
            .zhifubao {  
                width: 200px;  
                height: 50px;  
                margin-left: 50px;  
                background: url(../addons/xuan_mixloan/template/style/picture/alipay.png) ;
                background-size: 30px;    
                background-repeat: no-repeat;
                background-position: 10% 40%;
            }  
 
            #jine{ 
                -webkit-user-select:text; 
                text-align:right; 
                padding:0 1em; 
                border: 0px; 
                border-bottom:1px solid #ECB100; 
                border-radius: 0; 
                font-size:16px; 
                width:30%; 
                outline:none; 
                text-align:center; 
            } 
             
        </style> 
    </head> 
    <body> 
         <div class="mui-content"> 
                <div class="top" id="testLogin" > 
                    <input type="button" class="zhifubao" id="zhifubao" value="支付宝支付" style="margin-left: 22.5%" /> 
                </div> 
         </div> 
           <script> 
               var wxChannel = null; // 微信支付  
            var aliChannel = null; // 支付宝支付  
            var channel = null;   //支付通道 
            mui.init({  
                swipeBack:true //启用右滑关闭功能  
            });  
             
             mui.plusReady(function() {    
            // 获取支付通道  
                plus.payment.getChannels(function(channels){  
                for (var i in channels) { 
                        if (channels[i].id == "wxpay") { 
                             wxChannel=channels[i];  
                        }else{ 
                            aliChannel=channels[i];  
                        } 
                    }     
                },function(e){  
                 alert("获取支付通道失败："+e.message);  
                });  
        })  
  
        document.getElementById('zhifubao').addEventListener('tap',function() {  
            console.log("zhifubao");  
            pay('alipay');   
        })  
  
        var ALIPAYSERVER="{php echo $this->createMobileUrl('vip', array('op'=>'alipay_params'))}";  
        
        //发起支付请求  
        function pay(id){  
                var user_url = "{php echo $this->createMobileUrl('user')}";
                var PAYSERVER='';  
                if(id=='alipay'){  
                    PAYSERVER=ALIPAYSERVER;  
                    channel = aliChannel;  
                }
                var xhr=new XMLHttpRequest();  
                xhr.onreadystatechange=function(){  
                    switch(xhr.readyState){  
                        case 4:  
                        if(xhr.status==200){  
                            plus.payment.request(channel,xhr.responseText,function(result){  
                                mui.ajax("{php echo $this->createMobileUrl('vip', array('op'=>'alipay_notify'))}",{
                                    data:{},
                                    dataType:'json',
                                    type:'post',
                                    success:function(data){
                                        if (data.code == 1) {
                                            plus.nativeUI.alert("支付成功！",function(){ 
                                                mui.openWindow({url:user_url, id:'user_index', createNew:true});
                                            });  
                                        } else {
                                            plus.nativeUI.alert(data.msg,function(){ 
                                                mui.openWindow({url:user_url, id:'user_index', createNew:true});
                                            });
                                        }
                                    }
                                });
                            },function(error){  
                                plus.nativeUI.alert("支付失败：" + error.code, function(){
                                    mui.openWindow({url:user_url, id:'user_index', createNew:true});
                                });  
                            });  
                        }else{  
                            alert("获取订单信息失败！");  
                        }  
                        break;  
                    default:  
                    break;  
                }  
        }  
        xhr.open('GET',PAYSERVER);  
        xhr.send();  
            
    }  
     
    </script>   
    </body> 
</html>