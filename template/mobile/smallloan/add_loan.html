

<!DOCTYPE html>
<html lang="en">
<head>
    <title>返佣反馈</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="X-UA-Compatible" content="edge">
    <link rel="stylesheet" href="../addons/xuan_mixloan/template/style/new_loan/css/base.css">
    <link rel="stylesheet" href="../addons/xuan_mixloan/template/style/new_loan/css/bcardwithdraw.css">
    <script src="../addons/xuan_mixloan/template/style/new_loan/js/jquery-1.11.3.js"></script>
    <script src="../addons/xuan_mixloan/template/style/new_loan/js/lmy.js"></script>
    <style type="text/css">
        /*避免缓存*/
        div.bindCardBox ul li input{background: transparent;}
        .bindqrcode{width: 60%;height: 6rem; margin: 0 auto;}
        .chooseImg{
            position: absolute;
            display: inline-block;
            width: 4rem;
            height: 4rem;
            top: 2rem;
            left: 6rem;
        }
        div.bindCardBox a{background-color: #2e8ded;}
    </style>
</head>
<body class="bodybg">

<style type="text/css">
    .app_header{ height: 3.5rem; background: white}
    .app_header .div_back{position: absolute;top: 1.9rem;left: 0.8rem}
    .app_header .div_back img{width: 1rem}
    .header_title{position: absolute;top: 2em;left: 42%;font-size: 0.65rem}
</style>
<div class="app_header">
    <div class="div_back" onclick="mui.back()"><img src="../addons/xuan_mixloan/template/style/new_loan/images/back.png"></div>
    <div class="header_title">上传小贷</div>
</div>
<div class="bindCardBox" data-userId="10086" data-cardId="" data-urlIndex="1">
    <div class="bindCardMain" style="margin-top: 1rem">
        <ul>
            <li>
                <span>一级分类<em></em></span>
                <select style="width: 50%;background: white;" id="one_category">
                    <option value="">请选择一级分类</option>
                </select>
            </li>
            <li>
                <span>二级分类<em></em></span>
                <select style="width: 50%;background: white;" id="two_category">
                    <option value="">请选择二级分类</option>
                </select>
            </li>
            <li><span>小贷名称<em></em></span><input id="name" type="text" name="name" placeholder="小贷名称"></li>
            <li><span>小贷链接<em></em></span><input id="url" type="text" name="url" placeholder="小贷链接"></li>
            <li><span style="height: 2rem">小贷logo<em></em></span>
                <input type="file" value="" id="logo" >
                <input type="hidden" value="" id="logo_pic"  name="logo_pic" data-name="">
            </li>
        </ul>
    </div>
    <!-- <div class="tips" style="text-align: center;font-size: 0.6rem;margin-top: 1rem">
        提示：通过审核后能得到现金奖励哦
    </div> -->
    <a href="javascript:void(0);" id="bind_card" onclick="regSubmit();">提交</a>
</div>
<!-- js&&插件 -->
<script type="text/javascript" src="../addons/xuan_mixloan/template/style/js/layer.js"></script>
<script type="text/javascript" src="../addons/xuan_mixloan/template/style/mui/js/mui.min.js"></script>
<script type="text/javascript" src="../addons/xuan_mixloan/template/style/js/exif.js" ></script>
<script type="text/javascript">
    function openNew(url){
        mui.openWindow({url:url,createNew:true});
    }
    var user_id=$("div.bindCardBox").attr('data-userId');

    $.post("{php echo $this->createMobileUrl('smallloan', array('op' => 'index'))}", {}, function(data) {
        layer.closeAll();
        if(data.code==1){
            var str ='<option value="">请选择一级分类</option>';
            var list = data.data.list;
            for (var i = 0;i < list.length; i++) {
                str += '<option value="'+list[i].id+'">'+list[i].name+'</option>';
            }
            $('#one_category').html(str);
        }else{
            layer.msg(data.msg);
            return false;
        }
    }, "json");
    $('#one_category').change(function(){
        var bind_id = $('#one_category').val();
        $.post("{php echo $this->createMobileUrl('smallloan', array('op' => 'index_list'))}", {bind_id:bind_id}, function(data) {
            layer.closeAll();
            if(data.code==1){
                var str ='<option value="">请选择二级分类</option>';
                var list = data.data.list;
                for (var i = 0;i < list.length; i++) {
                    str += '<option value="'+list[i].id+'">'+list[i].name+'</option>';
                }
                $('#two_category').html(str);
            }else{
                layer.msg(data.msg);
                return false;
            }
        }, "json");
    })
    $("#logo").change(function(){
        type = 'logo_pic';
        index_lay = layer.load(1, {
            shade: [0.1,'#fff'] //0.1透明度的白色背景
        });
        var idFile = $(this).attr("id");
        var file = document.getElementById(idFile);
        var fileList = file.files; //获取的图片文件
        fileList = validateUp(fileList);
        if(fileList.length>0){
            var _file=fileList[0];
            readFile(_file);
        }
    })
    //上传图片(fileReader)
    var MAX_HEIGHT = 1000;//设置压缩图片的最大高度
    function readFile(file) {
        var reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function (e) {
            var carousel = this.result;
            console.log(carousel);
            render(carousel);
        }
    }

    var newImgFlag=true;//旋转处理后返回图片标识(是否旋转 true 旋转 false 原图片)
    //图片压缩后上传
    function render(src) {
        // 创建一个 Image 对象
        var image = new Image();
        image.src = src;
        // 绑定 load 事件处理器，加载完成后执行
        image.onload = function() {
            //旋转的图片矫正
            var newImage = rotateImage(image);
            console.log(newImage);
            if(newImgFlag){
                newImage.onload = function(){
                    postImg(newImage);
                }
            }else{
                postImg(newImage);
            }
            function postImg(){
                // 获取 canvas DOM 对象
                var canvas = document.createElement("canvas");
                // 如果高度超标
                if (newImage.height > MAX_HEIGHT && newImage.height >= newImage.width) {
                    // 宽度等比例缩放 *=
                    newImage.width *= MAX_HEIGHT / newImage.height;
                    newImage.height = MAX_HEIGHT;
                }
                //考虑到用户上传的有可能是横屏图片同样过滤下宽度的图片。
                if (newImage.width > MAX_HEIGHT && newImage.width > newImage.height) {
                    // 宽度等比例缩放 *=
                    newImage.height *= MAX_HEIGHT / newImage.width;
                    newImage.width = MAX_HEIGHT;
                }

                // 获取 canvas的 2d 画布对象,
                var ctx = canvas.getContext("2d");
                // canvas清屏，并设置为上面宽高
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                // 重置canvas宽高
                canvas.width = newImage.width;
                canvas.height = newImage.height;
                // 将图像绘制到canvas上
                ctx.drawImage(newImage, 0, 0, newImage.width, newImage.height);
                // !!! 注意，image 没有加入到 dom之中
                //document.getElementById('img').src = canvas.toDataURL("image/png");
                var blob = canvas.toDataURL("image/jpeg");
                console.log(blob);
                $.post("{php echo $this->createMobileUrl('user', array('op' => 'uploadImage'))}",{"carousel":blob},
                    function(res){
                        layer.closeAll();
                        console.log(res);
                        if(res.code==1){
                            var backImgUrl=res.data.avatar_url;
                            // if($("div.imgPreview ul li").length==3){
                            //     $("div.imgPreview ul li.addImg").hide();
                            // }
                            //向后追加新上传的图片
                            if (type == 'logo_pic') {
                                $("#logo_pic").attr("data-name",backImgUrl);
                            }
                        }else{
                            layer.msg(res.msg);
                            return false;
                        }
                    },'json')
            }
        };
    };
    //旋转图片矫正
    function rotateImage(image) {
        console.log('rotateImage');

        var width = image.width;
        var height = image.height;

        var canvas = document.createElement("canvas")
        var ctx = canvas.getContext('2d');

        var newImage = new Image();

        //旋转图片操作
        EXIF.getData(image,function () {
                var orientation = EXIF.getTag(this,'Orientation');
                // orientation = 6;//测试数据
                console.log('orientation:'+orientation);
                switch (orientation){
                    //正常状态
                    case 1:
                        console.log('旋转0°');
                        // canvas.height = height;
                        // canvas.width = width;
                        newImage = image;
                        newImgFlag=false;
                        break;
                    //旋转90度
                    case 6:
                        console.log('旋转90°');
                        canvas.height = width;
                        canvas.width = height;
                        ctx.rotate(Math.PI/2);
                        ctx.translate(0,-height);

                        ctx.drawImage(image,0,0)
                        imageDate = canvas.toDataURL('Image/jpeg',1)
                        newImage.src = imageDate;
                        newImgFlag=true;
                        break;
                    //旋转180°
                    case 3:
                        console.log('旋转180°');
                        canvas.height = height;
                        canvas.width = width;
                        ctx.rotate(Math.PI);
                        ctx.translate(-width,-height);

                        ctx.drawImage(image,0,0)
                        imageDate = canvas.toDataURL('Image/jpeg',1)
                        newImage.src = imageDate;
                        newImgFlag=true;
                        break;
                    //旋转270°
                    case 8:
                        console.log('旋转270°');
                        canvas.height = width;
                        canvas.width = height;
                        ctx.rotate(-Math.PI/2);
                        ctx.translate(-height,0);

                        ctx.drawImage(image,0,0)
                        imageDate = canvas.toDataURL('Image/jpeg',1)
                        newImage.src = imageDate;
                        newImgFlag=true;
                        break;
                    //undefined时不旋转
                    case undefined:
                        console.log('undefined  不旋转');
                        newImage = image;
                        newImgFlag=false;
                        break;
                }
            }
        );
        return newImage;
    }
    //验证图片类型大小
    function validateUp(files){
        var delParent;
        var defaults = {
            fileType         : ["jpg","png","jpeg"],   // 上传文件的类型
            fileSize         : 1024 * 1024 * 5        // 上传文件的大小 5M
        };
        var arrFiles = [];//替换的文件数组
        for(var i = 0, file; file = files[i]; i++){
            //获取文件上传的后缀名
            var newStr = file.name.split("").reverse().join("");
            if(newStr.split(".")[0] != null){
                var type = (newStr.split(".")[0].split("").reverse().join("")).toLowerCase();
                console.log(type+"===type===");
                if(jQuery.inArray(type, defaults.fileType) > -1){
                    // 类型符合，可以上传
                    if (file.size >= defaults.fileSize) {
                        layer.msg('文件过大',{time:800},function(){
                            layer.closeAll();
                        });
                        return false;
                    } else {
                        // 在这里需要判断当前所有文件中
                        arrFiles.push(file);
                    }
                }else{
                    layer.msg('上传类型不符合',{time:800},function(){
                        layer.closeAll();
                    });
                    return false;
                }
            }else{
                layer.msg('无法识别的文件',{time:800},function(){
                    layer.closeAll();
                });
                return false;
            }
        }
        return arrFiles;
    }
    //绑卡
    function regSubmit() {
        $("#bind_card").css({"color":"rgba(0,0,0,0.4)","background-color":"rgba(0,0,0,0.2)","box-shadow":"0 3px 20px rgba(0,0,0,0.2)"});
        $("#bind_card").attr("onclick",'javascript:void(0);');
        var logo_pic=$("#logo_pic").attr("data-name");  //头像
        var name=$("input[name='name']").val();  
        var url=$("input[name='url']").val();  
        var one_category=$("#one_category").val();  
        var two_category=$("#two_category").val();   
        if (name == "") {
            layer.msg("请填写名称");
            _click();
            return false;
        }
        if (url == "") {
            layer.msg("请填写链接");
            _click();
            return false;
        }
        if (one_category == "") {
            layer.msg("请选择一级分类");
            _click();
            return false;
        }
        if (two_category == "") {
            layer.msg("请选择二级分类");
            _click();
            return false;
        }
        if (logo_pic == "") {
            layer.msg("请上传小贷图标");
            _click();
            return false;
        }
        var imguploadimg=layer.load(1, {
            shade: [0.5,'#000']
        });
        _submit();
        //恢复点击
        function _click(){
            $("#bind_card").css({"color":"#fff","background-color":"#2e8ded"})
            $("#bind_card").attr("onclick","regSubmit();");
        }
        function dataTransform(res){
            var ret="";
            if(res==null||res==undefined){
                ret="";
            }else{
                ret=res;
            }
            return ret;
        }


        //信息验证正确，前往绑卡接口
        function _submit(){
            var ajax = {};
            ajax.url = "{php echo $this->createMobileUrl('smallloan', array('op' => 'add_smallloan_submit'))}";
            ajax.dataType = "json";
            ajax.type = "post";
            ajax.data = {'name':dataTransform(name),'one_category':dataTransform(one_category),'two_category':dataTransform(two_category),'logo_pic':dataTransform(logo_pic),'url':dataTransform(url)};
            ajax.success = function (data) {
                layer.closeAll();
                if (data.code == 1) {
                    layer.msg('提交成功', {
                        time: 2000 //2秒关闭（如果不配置，默认是3秒）
                    }, function(){
                        _url = data.data.url;
                        openNew(_url);
                    });
                } else {
                    layer.msg(data.msg, function(){
                        if (data.data.url) {
                            _url = data.data.url;
                            openNew(_url);
                        }
                    });
                    _click();
                    return false;
                }
            }
            $.ajax(ajax);
        }
    }
</script>

</body>
</html>